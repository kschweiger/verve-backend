name: Run Pytest Suite

on:
  push:
    branches:
      - "main"
      - "ci/**"
  pull_request:
    branches:
      - "main"
      - "ci/**"
    types:
      - opened
      - synchronize

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgis/postgis:17-3.4
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install and Configure Service Clients
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Create PostgreSQL Schema
        env:
          PGPASSWORD: testpassword
        run: |
          psql -h localhost -U testuser -d testdb -c "CREATE SCHEMA api;"

      - name: Enable PostGIS Extension
        env:
          PGPASSWORD: testpassword
        run: |
          psql -h localhost -U testuser -d testdb -c "CREATE EXTENSION IF NOT EXISTS postgis;"

      - name: Configure RLS User and Permissions
        env:
          PGPASSWORD: testpassword
        run: |
          psql -h localhost -U testuser -d testdb -c "
            CREATE ROLE verve_user LOGIN PASSWORD 'rlstestpassword' NOINHERIT;
            GRANT USAGE ON SCHEMA api TO verve_user;
            ALTER DEFAULT PRIVILEGES IN SCHEMA api GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO verve_user;
            ALTER DEFAULT PRIVILEGES IN SCHEMA api GRANT USAGE ON SEQUENCES TO verve_user;
          "
      - name: Start MinIO service
        run: |
          docker run -d --name minio-container \
            -p 9000:9000 \
            -p 9001:9001 \
            -e "MINIO_ROOT_USER=minioadmin" \
            -e "MINIO_ROOT_PASSWORD=minioadmin" \
            minio/minio server /data --console-address ":9001"

      - name: Configure MinIO (Create Bucket)
        run: |
          sleep 5
          docker run --rm --network=host minio/mc \
            alias set myminio http://localhost:9000 minioadmin minioadmin
          docker run --rm --network=host minio/mc \
            mb myminio/verve-testing

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Install uv and enable caching
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Install main and test dependencies from lock file
        run: uv sync --locked --group test --no-dev

      - name: Run pytest
        run: uv run pytest
        env:
          # Application Settings
          FRONTEND_HOST: "http://localhost:3000"
          SECRET_KEY: "djgaherluhglaeiruhgluie"
          # Service Connection Settings
          POSTGRES_SERVER: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB_TESTING: testdb
          POSTGRES_SCHEMA_NAME: "verve"
          POSTGRES_RLS_USER: "verve_user"
          POSTGRES_RLS_PASSWORD: "rlstestpassword"
          BOTO3_ENDPOINT: "http://localhost:9000"
          BOTO3_ACCESS: minioadmin
          BOTO3_SECRET: minioadmin
